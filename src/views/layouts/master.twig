{# ============================================================
   NAJD THEME ‚Äî Master Layout
   3 Modes: Light / Dark / Glass (Liquid Glass)
   Premium Features: Preloader, Newsletter Popup, Shipping Bar,
                     Mobile Bottom Nav, Quick View
   ============================================================ #}
<!DOCTYPE html>
<html lang="{{ user.language.code }}" dir="{{ user.language.dir }}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {{ theme.settings.set('placeholder', 'images/placeholder.png') }}

    {# ---- Page-specific head scripts ---- #}
    <script defer data-cfasync="false" crossorigin="anonymous" src="{{ 'product-card.js'|asset }}"></script>
    <script defer src="{{ 'main-menu.js'|asset }}"></script>
    <script defer src="{{ 'theme-mode.js'|asset }}"></script>
    {% if theme.settings.get('default_theme_mode') == 'glass' %}
        <script defer src="{{ 'liquid-glass.js'|asset }}"></script>
    {% endif %}
    {% block head_scripts %}{% endblock %}

    {# ---- Pass theme settings to JS ---- #}
    <script data-cfasync="false">
        window.najdConfig = {
            defaultMode:        "{{ theme.settings.get('default_theme_mode', 'light') }}",
            glassBlur:          "{{ theme.settings.get('glass_blur_intensity', 'medium') }}",
            headerIsSticky:     {{ theme.settings.get('header_is_sticky', true) ? 'true' : 'false' }},
            headerStyle:        "{{ theme.settings.get('header_style', 'classic') }}",
            imageZoom:          {{ theme.settings.get('imageZoom', true) ? 'true' : 'false' }},
            enableToast:        {{ theme.settings.get('enable_add_product_toast', true) ? 'true' : 'false' }},
            enableAnimations:   {{ theme.settings.get('enable_home_animations', true) ? 'true' : 'false' }},
            protectContent:     {{ theme.settings.get('protect_content', false) ? 'true' : 'false' }},
            isRtl:              {{ theme.is_rtl ? 'true' : 'false' }},
            canAccessWallet:    {{ user.can_access_wallet | json_encode }},
            enableMoreMenu:     {{ theme.settings.get('enable_more_menu', true) ? 'true' : 'false' }},
            quickView:          {{ theme.settings.get('quick_view_enabled', true) ? 'true' : 'false' }},
            gridListToggle:     {{ theme.settings.get('grid_list_toggle', true) ? 'true' : 'false' }},
            freeShippingBar:    {{ theme.settings.get('free_shipping_bar_enabled', false) ? 'true' : 'false' }},
            freeShippingGoal:   {{ theme.settings.get('free_shipping_goal', 200) }},
            mobileBottomNav:    {{ theme.settings.get('mobile_bottom_nav', false) ? 'true' : 'false' }},
            parallax:           {{ theme.settings.get('parallax_enabled', true) ? 'true' : 'false' }},
            hoverEffect:        "{{ theme.settings.get('hover_effect_style', 'lift') }}",
            preloader:          {{ theme.settings.get('preloader_enabled', false) ? 'true' : 'false' }},
            preloaderStyle:     "{{ theme.settings.get('preloader_style', 'spinner') }}",
            newsletterPopup:    {{ theme.settings.get('newsletter_popup_enabled', false) ? 'true' : 'false' }},
            newsletterDelay:    {{ theme.settings.get('newsletter_popup_delay', 5) }},
            sizeChart:          {{ theme.settings.get('size_chart_enabled', false) ? 'true' : 'false' }},
        };
    </script>

    {# ---- Salla hooks & styles ---- #}
    {% hook 'head:start' %}
    {% hook head %}
    {% block styles %}{% endblock %}
    <link rel="stylesheet" href="{{ 'app.css' | asset }}">
    <link rel="stylesheet" href="{{ theme.font.path|cdn }}"/>
    <link rel="stylesheet" href="{{ 'fonts/sallaicons.css'|cdn }}"/>

    {# ---- CSS Custom Properties from theme settings ---- #}
    <style>
        :root {
            /* Font */
            --font-main: '{{ theme.font.name }}';

            /* Primary color from Salla dashboard */
            --color-primary:         {{ theme.color.primary }};
            --color-primary-dark:    {{ theme.color.darker(0.15) }};
            --color-primary-light:   {{ theme.color.lighter(0.15) }};
            --color-primary-reverse: {{ theme.color.reverse_text }};

            /* Light mode colors */
            --light-bg-primary:    {{ theme.settings.get('light_bg_primary',   '#ffffff') }};
            --light-bg-secondary:  {{ theme.settings.get('light_bg_secondary', '#f8f9fc') }};
            --light-text-primary:  {{ theme.settings.get('light_text_primary', '#111827') }};
            --light-text-secondary:{{ theme.settings.get('light_text_secondary','#4b5563') }};
            --light-header-bg:     {{ theme.settings.get('light_header_bg',    '#ffffff') }};
            --light-header-text:   {{ theme.settings.get('light_header_text',  '#111827') }};
            --light-card-bg:       {{ theme.settings.get('light_card_bg',      '#ffffff') }};

            /* Dark mode colors */
            --dark-bg-primary:     {{ theme.settings.get('dark_bg_primary',    '#1d1f1f') }};
            --dark-bg-secondary:   {{ theme.settings.get('dark_bg_secondary',  '#0e0f0f') }};
            --dark-text-primary:   {{ theme.settings.get('dark_text_primary',  '#ffffff') }};
            --dark-text-secondary: {{ theme.settings.get('dark_text_secondary','#cccccc') }};
            --dark-header-bg:      {{ theme.settings.get('dark_header_bg',     '#0e0f0f') }};
            --dark-card-bg:        {{ theme.settings.get('dark_card_bg',       '#1d1f1f') }};

            /* Glass mode scene ‚Äî AI-Inspired */
            --glass-scene-1:  {{ theme.settings.get('glass_scene_color_1', '#050511') }};
            --glass-scene-2:  {{ theme.settings.get('glass_scene_color_2', '#0C1120') }};
            --glass-orb-1:    {{ theme.settings.get('glass_orb_color_1',   '#BC82F3') }};
            --glass-orb-2:    {{ theme.settings.get('glass_orb_color_2',   '#5AC8FA') }};
            --glass-orb-3:    {{ theme.settings.get('glass_orb_color_3',   '#F5B9EA') }};

            /* Footer */
            --footer-bg:   {{ theme.settings.get('footer_bg_color',   '#f3f4f6') }};
            --footer-text: {{ theme.settings.get('footer_text_color', '#374151') }};

            /* Announcement */
            {% if theme.settings.get('announcement_bg_color') %}
            --announcement-bg:   {{ theme.settings.get('announcement_bg_color') }};
            {% endif %}
            {% if theme.settings.get('announcement_text_color') %}
            --announcement-text: {{ theme.settings.get('announcement_text_color') }};
            {% endif %}

            /* Accent color */
            {% if theme.settings.get('accent_color') %}
            --color-accent: {{ theme.settings.get('accent_color') }};
            {% endif %}

            /* ‚≠ê Gradient Builder */
            {% if theme.settings.get('gradient_primary_start') %}
            --gradient-start: {{ theme.settings.get('gradient_primary_start') }};
            {% endif %}
            {% if theme.settings.get('gradient_primary_end') %}
            --gradient-end: {{ theme.settings.get('gradient_primary_end') }};
            {% endif %}
            --gradient-direction: {{ theme.settings.get('gradient_direction', '135deg') }};

            /* ‚≠ê Section Spacing */
            --block-padding-y: {{ theme.settings.get('spacing_desktop_v', 64) }}px;
            --block-padding-x: {{ theme.settings.get('spacing_h', 0) }}px;
            --block-gap: {{ theme.settings.get('section_gap', 0) }}px;

            /* ‚≠ê Announcement Bar */
            --ann-padding: {{ theme.settings.get('ann_padding', 12) }}px;
            --ann-margin-top: {{ theme.settings.get('ann_margin_top', 0) }}px;
            --ann-margin-bottom: {{ theme.settings.get('ann_margin_bottom', 0) }}px;
            {% set ann_speed_val = theme.settings.get('ann_speed', 5) %}
            --ann-speed: {{ 70 - (ann_speed_val * 6) }}s;
        }

        /* Tablet spacing override */
        @media (max-width: 1024px) {
            :root { --block-padding-y: {{ theme.settings.get('spacing_tablet_v', 48) }}px; }
        }
        /* Mobile spacing override */
        @media (max-width: 768px) {
            :root { --block-padding-y: {{ theme.settings.get('spacing_mobile_v', 32) }}px; }
        }
    </style>

    {# ‚≠ê Custom CSS injection #}
    {% if theme.settings.get('custom_css') %}
    <style id="najd-custom-css">/* Najd Custom CSS ‚Äî Applied by store owner */
{{ theme.settings.get('custom_css') }}</style>
    {% endif %}

    {% if theme.settings.get('custom_favicon') %}
        <link rel="icon" href="{{ theme.settings.get('custom_favicon') }}" type="image/png">
    {% endif %}
    {% hook 'head:end' %}
</head>

<body
    id="app"
    class="theme-najd overflow-x-hidden {% hook 'body:classes' %}
        {{ theme.settings.get('footer_is_dark') ? ' footer-is-dark' : ' footer-is-light' }}
        {{ theme.settings.get('topnav_is_dark') ? ' topnav-is-dark' : '' }}
        {{ theme.settings.get('sticky_add_to_cart') ? ' is-sticky-product-bar' : '' }}
        {{ theme.settings.get('mobile_bottom_nav') ? ' has-mobile-nav' : '' }}"
    data-theme="{{ theme.settings.get('default_theme_mode', 'light') }}"
    data-spacing="{{ theme.settings.get('section_spacing', 'normal') }}"
    data-radius="{{ theme.settings.get('border_radius_style', 'rounded') }}"
    data-card-style="{{ theme.settings.get('card_style', 'default') }}"
    data-hover="{{ theme.settings.get('hover_effect_style', 'lift') }}"
    data-heading-style="{{ theme.settings.get('heading_style', 'simple') }}"
    data-heading-align="{{ theme.settings.get('heading_align', 'center') }}"
    data-heading-size="{{ theme.settings.get('heading_size', 'medium') }}"
    data-product-card="{{ theme.settings.get('product_card_style', 'classic') }}"
    data-btn-style="{{ theme.settings.get('button_style', 'rounded') }}"
    data-shadow="{{ theme.settings.get('card_shadow_intensity', 'light') }}"
    data-anim-speed="{{ theme.settings.get('animation_speed', 'normal') }}"
    data-img-ratio="{{ theme.settings.get('product_image_ratio', 'auto') }}"
    data-card-hover="{{ theme.settings.get('product_card_hover_effect', 'lift') }}"
    data-section-alt="{{ theme.settings.get('section_alt_bg') ? 'true' : 'false' }}"
    data-section-divider="{{ theme.settings.get('section_divider', 'none') }}"
    data-color-preset="{{ theme.settings.get('color_preset', 'custom') }}"
>

{# ===== Preloader ===== #}
{% if theme.settings.get('preloader_enabled', false) %}
    {% set preloader_style = theme.settings.get('preloader_style', 'spinner') %}
    <div class="najd-preloader najd-preloader--{{ preloader_style }}" id="najd-preloader">
        {% if preloader_style == 'logo' %}
            <img src="{{ theme.settings.get('custom_preloader_image') ?: store.logo|cdn(175) }}" alt="{{ store.name }}" class="najd-preloader__logo">
        {% elseif preloader_style == 'progress' %}
            <div class="najd-preloader__bar"><div class="najd-preloader__bar-fill"></div></div>
        {% else %}
            <div class="najd-preloader__spinner"></div>
        {% endif %}
    </div>
{% endif %}

<noscript>
    To get full functionality of this site you need to enable JavaScript. Here is how
    <a href="https://www.enable-javascript.com/" rel="noreferrer" target="_blank">To enable JavaScript on webpage</a>.
</noscript>

{# ---- Glass Mode Background Scene ---- #}
<div class="najd-bg-scene" aria-hidden="true">
    <div class="najd-bg-scene__gradient"></div>
    <div class="najd-bg-scene__orb najd-bg-scene__orb--1"></div>
    <div class="najd-bg-scene__orb najd-bg-scene__orb--2"></div>
    <div class="najd-bg-scene__orb najd-bg-scene__orb--3"></div>
    <div class="najd-bg-scene__mesh"></div>
</div>

{# ===== Free Shipping Progress Bar ===== #}
{% if theme.settings.get('free_shipping_bar_enabled', false) %}
    <div class="najd-shipping-bar" id="najd-shipping-bar">
        <div class="container">
            <div class="najd-shipping-bar__inner">
                <i class="sicon-shipping-fast"></i>
                <span class="najd-shipping-bar__text">
                    {{ trans('common.elements.free_shipping_goal') }}
                </span>
                <div class="najd-shipping-bar__progress">
                    <div class="najd-shipping-bar__fill" id="najd-shipping-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<div class="app-inner flex flex-col min-h-full">
    {% hook 'body:start' %}

    {# ---- ‚≠ê Advanced Announcement Bar ---- #}
    {% set ann_text = theme.settings.get('announcement_text') %}
    {% set ann_messages_raw = theme.settings.get('ann_messages') %}
    {% if ann_text or ann_messages_raw %}
        {% set ann_animation = theme.settings.get('ann_animation', 'ticker') %}
        {% set ann_shape = theme.settings.get('ann_shape', 'flat') %}
        {% set ann_preset = theme.settings.get('ann_color_preset', 'custom') %}
        {% set ann_emoji = theme.settings.get('ann_emoji', '') %}
        {% set ann_pause = theme.settings.get('ann_pause_hover', true) %}
        {% set ann_full_width = theme.settings.get('ann_full_width', false) %}

        <div class="najd-announcement najd-announcement--{{ ann_shape }}"
             id="najd-announcement"
             data-ann-animation="{{ ann_animation }}"
             data-ann-preset="{{ ann_preset }}"
             data-ann-pause="{{ ann_pause ? 'true' : 'false' }}">
            <div class="{{ ann_full_width ? '' : 'container' }}">
                <div class="najd-announcement__inner">

                    {% if ann_messages_raw %}
                        {# ‚≠ê Multi-message rotation mode ‚Äî JS handles fade cycling #}
                        <div class="najd-announcement__msg-wrap"
                             data-messages="{{ ann_messages_raw|e('html_attr') }}"
                             data-emoji="{{ ann_emoji }}">
                            <span class="najd-announcement__msg-text">
                                {% if ann_emoji %}{{ ann_emoji }} {% endif %}{{ ann_messages_raw|split('\n')|first|trim }}
                            </span>
                        </div>
                    {% else %}
                        {# Single message ‚Äî ticker or chosen animation #}
                        <div class="najd-announcement__ticker-wrap" aria-live="polite">
                            <div class="najd-announcement__track">
                                {% for i in 1..4 %}
                                    <span class="najd-announcement__item">
                                        {% if ann_emoji %}{{ ann_emoji }}&nbsp;{% endif %}
                                        {% if theme.settings.get('announcement_url') %}
                                            <a href="{{ theme.settings.get('announcement_url') }}">{{ ann_text }}</a>
                                        {% else %}
                                            {{ ann_text }}
                                        {% endif %}
                                        &nbsp;&nbsp;‚ú¶&nbsp;&nbsp;
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {% if theme.settings.get('announcement_closable', true) %}
                        <button class="najd-announcement__close" id="najd-ann-close" aria-label="ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ•ÿπŸÑÿßŸÜ">
                            <i class="sicon-cancel"></i>
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    {# ---- Header ---- #}
    {% component 'header.header' %}

    {# ---- Main Content ---- #}
    <main id="main-content" role="main">
        {% block content %}{% endblock %}
    </main>

    {# ---- Footer ---- #}
    {% component 'footer.footer' %}
</div>

{# ---- WhatsApp Button ---- #}
{% if theme.settings.get('show_whatsapp_btn', true) and store.contacts.whatsapp %}
    {% set wa_pos   = theme.settings.get('whatsapp_btn_position', 'right') %}
    {% set wa_shape = theme.settings.get('whatsapp_btn_shape', 'circle') %}
    {% set wa_color = theme.settings.get('whatsapp_btn_color', 'official') %}
    <a href="https://wa.me/{{ store.contacts.whatsapp }}"
       class="najd-whatsapp-btn najd-whatsapp-btn--{{ wa_pos }} najd-whatsapp-btn--{{ wa_shape }} najd-whatsapp-btn--{{ wa_color }} glass-surface"
       target="_blank"
       rel="noopener noreferrer"
       aria-label="WhatsApp">
        <i class="sicon-whatsapp"></i>
    </a>
{% endif %}

{# ---- Back to Top ---- #}
{% if theme.settings.get('show_back_to_top', true) %}
    {% set btt_pos   = theme.settings.get('back_to_top_position', 'right') %}
    {% set btt_shape = theme.settings.get('back_to_top_shape', 'rounded-square') %}
    <button class="najd-back-to-top najd-back-to-top--{{ btt_pos }} najd-back-to-top--{{ btt_shape }} glass-surface" id="najd-back-to-top" aria-label="Back to top">
        <i class="sicon-keyboard-arrow-up"></i>
    </button>
{% endif %}

{# ===== Mobile Bottom Navigation ===== #}
{% if theme.settings.get('mobile_bottom_nav', false) %}
    <nav class="najd-mobile-nav" id="najd-mobile-nav">
        <a href="{{ link('/') }}" class="najd-mobile-nav__item {{ is_page('index') ? 'is-active' : '' }}">
            <i class="sicon-home"></i>
            <span>{{ trans('common.elements.home') }}</span>
        </a>
        <a href="{{ link('products') }}" class="najd-mobile-nav__item {{ is_page('products') ? 'is-active' : '' }}">
            <i class="sicon-shopping-bag"></i>
            <span>{{ trans('common.elements.products') }}</span>
        </a>
        <button class="najd-mobile-nav__item najd-mobile-nav__item--cart" onclick="salla.event.dispatch('cart::open')">
            <i class="sicon-shopping-cart"></i>
            <span>{{ trans('common.elements.cart') }}</span>
            {% if cart.items_count > 0 %}
                <span class="najd-mobile-nav__badge">{{ cart.items_count }}</span>
            {% endif %}
        </button>
        <a href="{{ link('wishlist') }}" class="najd-mobile-nav__item">
            <i class="sicon-heart"></i>
            <span>{{ trans('common.elements.wishlist') }}</span>
        </a>
        {% if user.type == 'user' %}
            <a href="{{ link('profile') }}" class="najd-mobile-nav__item">
                <i class="sicon-user-circle"></i>
                <span>{{ trans('common.elements.account') }}</span>
            </a>
        {% else %}
            <button class="najd-mobile-nav__item" onclick="salla.event.dispatch('login::open')">
                <i class="sicon-user-circle"></i>
                <span>{{ trans('common.elements.login') }}</span>
            </button>
        {% endif %}
    </nav>
{% endif %}

{# ===== Newsletter Popup ===== #}
{% if theme.settings.get('newsletter_popup_enabled', false) %}
    <div class="najd-newsletter-popup" id="najd-newsletter-popup" style="display:none">
        <div class="najd-newsletter-popup__overlay" onclick="document.getElementById('najd-newsletter-popup').style.display='none'; localStorage.setItem('najd-nl-dismissed', Date.now())"></div>
        <div class="najd-newsletter-popup__content glass-surface">
            <button class="najd-newsletter-popup__close" onclick="document.getElementById('najd-newsletter-popup').style.display='none'; localStorage.setItem('najd-nl-dismissed', Date.now())">
                <i class="sicon-cancel"></i>
            </button>
            <div class="najd-newsletter-popup__body">
                {% if theme.settings.get('newsletter_popup_image') %}
                    <div class="najd-newsletter-popup__image">
                        <img src="{{ theme.settings.get('newsletter_popup_image') }}" alt="Newsletter" loading="lazy">
                    </div>
                {% endif %}
                <div class="najd-newsletter-popup__form">
                    <h3 class="text-xl lg:text-2xl font-bold mb-2">{{ trans('blocks.footer.newsletter') }}</h3>
                    <p class="text-sm opacity-70 mb-6">{{ trans('blocks.footer.newsletter_desc') }}</p>
                    <salla-newsletter></salla-newsletter>
                </div>
            </div>
        </div>
    </div>
{% endif %}

{# ===== Discount Popup ===== #}
{% if theme.settings.get('discount_popup_enabled', false) %}
    <div class="najd-discount-popup" id="najd-discount-popup" style="display:none">
        <div class="najd-discount-popup__overlay" onclick="document.getElementById('najd-discount-popup').style.display='none'; localStorage.setItem('najd-discount-dismissed', Date.now())"></div>
        <div class="najd-discount-popup__content">
            <button class="najd-discount-popup__close" onclick="document.getElementById('najd-discount-popup').style.display='none'; localStorage.setItem('najd-discount-dismissed', Date.now())">
                <i class="sicon-cancel"></i>
            </button>
            <div class="najd-discount-popup__body">
                {% if theme.settings.get('discount_popup_image') %}
                    <div class="najd-discount-popup__image">
                        <img src="{{ theme.settings.get('discount_popup_image') }}" alt="" loading="lazy">
                    </div>
                {% endif %}
                <div class="najd-discount-popup__info">
                    {% if theme.settings.get('discount_popup_percentage') %}
                        <div class="najd-discount-popup__badge">
                            {{ theme.settings.get('discount_popup_percentage') }}
                        </div>
                    {% endif %}
                    {% if theme.settings.get('discount_popup_title') %}
                        <h3 class="text-xl font-bold mb-4">{{ theme.settings.get('discount_popup_title') }}</h3>
                    {% endif %}
                    {% if theme.settings.get('discount_popup_code') %}
                        <div class="najd-discount-popup__code" id="najd-discount-code" onclick="navigator.clipboard.writeText('{{ theme.settings.get('discount_popup_code') }}'); this.classList.add('is-copied');">
                            <span>{{ theme.settings.get('discount_popup_code') }}</span>
                            <i class="sicon-copy"></i>
                        </div>
                        <p class="text-xs opacity-50 mt-2">{{ trans('common.elements.click_to_copy') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

{# ---- Salla hooks & components ---- #}
{% hook 'body:end' %}

{% if theme.settings.get('enable_add_product_toast', true) %}
    <salla-add-product-toast></salla-add-product-toast>
{% endif %}

<script defer crossorigin="anonymous" src="{{ 'app.js' | asset }}"></script>

<salla-offer-modal></salla-offer-modal>
<salla-search></salla-search>

{% if user.type == 'guest' %}
    <salla-login-modal></salla-login-modal>
{% endif %}

{% if store.scope %}
    <salla-scopes selection="{{ store.scope.display_as == 'popup' ? 'mandatory' : 'optional' }}"></salla-scopes>
{% endif %}

{% block scripts %}{% endblock %}

{# ‚≠ê Custom JS injection ‚Äî runs after full page load #}
{% if theme.settings.get('custom_js') %}
<script id="najd-custom-js">
window.addEventListener('load', function() {
  try {
    {{ theme.settings.get('custom_js') }}
  } catch(e) {
    console.warn('[Najd] Custom JS error:', e.message);
  }
});
</script>
{% endif %}

{# üõ†Ô∏è Developer Mode indicator #}
{% if theme.settings.get('developer_mode') %}
<script>
console.info('%c[Najd Theme v3] Developer Mode Active', 'color:#6366f1;font-weight:bold;font-size:14px');
console.table({ settings: {{ theme.settings|json_encode }}, mode: "{{ theme.settings.get('default_theme_mode') }}", colorPreset: "{{ theme.settings.get('color_preset', 'custom') }}" });
</script>
{% endif %}
</body>
</html>
